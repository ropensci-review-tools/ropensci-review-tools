# Extending or modifying checks

This vignette describes how to modify or extend the existing suite of
checks performed by `pkgcheck`. It is primarily based around the example
of the [`pkg_has_scrap()`
function](https://github.com/ropensci-review-tools/pkgcheck/blob/d02dcb630e5f38f599b6186580001510ffc5b314/R/misc-checks.R#L347-L368)
contributed by Maëlle Salmon ([@maelle](https://github.com/maelle)) via
[this pull
request](https://github.com/ropensci-review-tools/pkgcheck/pull/27).

## 1. Create a new check

New checks can be placed anywhere within the current code, including in
new files within the `R` directory. The [`pkg_has_scrap()`
function](https://github.com/ropensci-review-tools/pkgcheck/blob/d02dcb630e5f38f599b6186580001510ffc5b314/R/misc-checks.R#L347-L368)
is relatively short, and so was appended to the [`R/misc-checks.R`
file](https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/misc-checks.R).
Importantly check functions may not return `NULL`. If a `NULL`-like
return value is desired, it should be a zero-length vector of
appropriate type. For example, the [`pkg_has_scrap()`
function](https://github.com/ropensci-review-tools/pkgcheck/blob/d02dcb630e5f38f599b6186580001510ffc5b314/R/misc-checks.R#L347-L368)
returns the names of any “scrap” files included within a git repository
(implying files that should generally not be committed and included). If
none are included, the function returns `character(0)` and not `NULL`.

The values returned are used to construct messages issued by `pkgcheck`
in response to these checks, so it is generally better to return actual
values, rather than generic `TRUE`, `FALSE`, or other symbolic values.
This point is illustrated below in the demonstration of the `print()`
method.

## 2. Add check function to `pkgcheck` output

A new check function can be added to the result returned by [the
`pkgcheck()`
function](https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/pkgcheck-fn.R)
by inserting it below the commented line,
`# ----- Add new checks here ---`. The `pkg_has_scrap()` function is
included within that section to illustrate. New checks inserted in that
location will by default appear in a “Miscellaneous checks” section of
the report. Checks may be inserted in other locations by inserting them
elsewhere within the sequence specified in this [main `pkgcheck()`
function](https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/pkgcheck-fn.R).

## 3. Modify tests to include new check

Tests may be updated as soon as new items are returned by the [main
`pkgcheck()`
function](https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/pkgcheck-fn.R).
This generally requires the two simple modifications of:

1.  Adding the name of the new test to the [list of “items” expected in
    the result of the main `pkgcheck`
    call](https://github.com/ropensci-review-tools/pkgcheck/blob/a3507752b00b2206aee34ecbe99424d4cadb59f8/tests/testthat/test-pkgcheck.R#L19-L33).
2.  Increase the [expected length of the result of
    `pkgcheck()`](https://github.com/ropensci-review-tools/pkgcheck/blob/a3507752b00b2206aee34ecbe99424d4cadb59f8/tests/testthat/test-bg.R#L29)
    by one for each new test. The expected length is currently 15.

## 4. Add check result to summary output

All `pkgcheck` objects have a `summary` method which generates the
screen print indicating whether or not all expected checks have been
passed, and whether or not a package is ready to be submitted for peer
review to rOpenSci. The printed summary is first generated by a function
called
[`collate_checks()`](https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/collate-checks.R),
which calls a series of sub-functions, generally one for each kind of
check. New checks require new sub-functions, as can be seen by [the call
to
`collate_scrap_checks (checks)`](https://github.com/ropensci-review-tools/pkgcheck/blob/a3507752b00b2206aee34ecbe99424d4cadb59f8/R/collate-checks.R#L29).
New “collate” methods should all be inserted within this single
[`collate-checks.R`
file](https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/collate-checks.R),
and should be prefixed with `collate_`.

A collate method must begin within a least two [`roxygen2` comment
lines](https://roxygen2.r-lib.org), the second of which is `#' @noRd` to
suppress translation to a documentation (`.Rd`) file. The first of these
is explained at the top of that file, and should be either

``` r
#' @return Tick or cross
```

or,

``` r
#' @return Cross only
```

(with optional additional explanatory text). The first option is
generally used for more important tests, and indicates that a green tick
or red cross will appear to indicate that the test is respectively
either passed or failed. Some tests only prompt a red cross when they
fail, and do not appear in the summary list when they pass. These
specify return values with the second option, `#' @return Cross only`.

The [`collate_scrap_checks()`
function](https://github.com/ropensci-review-tools/pkgcheck/blob/a3507752b00b2206aee34ecbe99424d4cadb59f8/R/collate-checks.R#L310-L323)
has “Cross only”, and returns `NULL` is the test is passed. If the test
is failed, it appends a simple message to the initial symbols,
`paste0 ("-", symbol_crs ())`, where `symbol_crs()` encodes the red
cross, and `symbol_tck()` the green tick for passing checks. The message
should generally be short and simple. Full information returned from the
actual check function should generally be used only in the `print`
method (described below), and not in the `summary` method.

Finally, the name of the sub-function should then be added to the
sequence of function calls in the main [`collate_checks()`
function](https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/collate-checks.R),
in which the section of “Miscellaneous Checks” is clearly indicated.

## 5. Add new check result to print output

As described above, summary checks generally only print a short, fixed
message indicating whether or test a check has been passed. Detailed
returns by the actual check function are generally only shown via the
[`print`
method](https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/pkgcheck-methods.R)
associated with `pkgcheck` objects. The `print` method for any new check
items is generally implemented by constructing an associated function;
the `pkg_has_scrap()` function, for example, is called
[`print_scrap()`](https://github.com/ropensci-review-tools/pkgcheck/blob/a3507752b00b2206aee34ecbe99424d4cadb59f8/R/pkgcheck-methods.R#L183-L192).
That function demonstrates that all output uses the [`cli`
package](https://cli.r-lib.org), including in this example the [“list
item” function (`cli_li`)](https://cli.r-lib.org/reference/cli_li.html).

The `print` methods generally hand-code the different responses for
passing and failing checks. The [`pkg_has_scrap()`
function](https://github.com/ropensci-review-tools/pkgcheck/blob/d02dcb630e5f38f599b6186580001510ffc5b314/R/misc-checks.R#L347-L368)
only returns values when it fails, so only requires a `print` method on
check failures. The pass (tick) and fail (cross) symbols are translated
into corresponding `cli` symbols as follows:

| `summary` symbol | `print` symbol           |
|------------------|--------------------------|
| symbol_crs()     | cli::cli_alert_danger()  |
| symbol_tck()     | cli::cli_alert_success() |

See other functions in the main [`pgkcheck-methods.R`
file](https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/pkgcheck-methods.R)
for examples. And that is all the steps required to add a new check.

## 6. Convert new check result to markdown output

The `summary` and `print` methods described above are used to control
the appearance of checks on local terminal screens. The `pkgcheck`
package also includes a function to convert checks to markdown format,
the most important purpose of which is to render the checks for
inserting within GitHub issues. For any new checks to appear in the
reports generated by `ropensci-review-bot`, they need to be added to the
[`checks_to_markdown()`
function](https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/format-checks.R).
The place to insert new functions is indicated in the
`checks_to_markdown()` function by the comment line,
`# ----- Add new checks here ----`, similar to how new checks are added
to the main `pgkcheck()` function described in the second section above.

The format of these functions is best illustrated by example, with the
conversion function for the scrap checks looking like this:

``` r
scrap_checks_md <- function (checks) {

    if (length (checks$scrap) == 0L)
        return (NULL)

    c ("",
       ":heavy_check_mark: Package contains the following unexpected files:",
       "",
       paste0 ("- ", checks$scrap),
       "")
}
```

This function returns nothing if there are no scrap files, as specified
by the `roxygen2` comments of `#' @return cross only` in the
corresponding function in [the `collate_checks.R`
file](https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/collate-checks.R)),
described in section 4, above. Packages which contain scrap files will
then produce the message specified by that function, including the name
of each scrap file as a list item.

Once again, the green ticks and red crosses need to be converted to a
different format, using the following markdown conversions:

| `summary` symbol | markdown symbol          |
|------------------|--------------------------|
| symbol_crs()     | :heavy_multiplication_x: |
| symbol_tck()     | :heavy_check_mark:       |

Note also that the text output of these markdown-formatted checks
generally starts and ends with a blank line (`""`). These lines are
important to ensure appropriate rendering of HTML components.
